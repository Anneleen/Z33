<!DOCTYPE html> 
<html manifest="cache.manifest">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1"/>
	
	<title>Expo 2</title>
	<link rel="stylesheet" href="themes/z33.min.css"/>
	<script type="text/javascript" src="jquery/jquery-1.8.2.min.js"></script>
	<script type="text/javascript" src="jquery/jquery.mobile-1.2.0.min.js"></script>
	<script stype="text/javascript" src="phonegap.js"></script> 
	
	<script src="jquery/jquery.imagesloaded.min.js"></script>
	<script src="jquery/imgcache.js"></script>
	
	<script>
		var startTest = function() {
			$('body').imagesLoaded(function($images, $proper, $broken ) {

				// see console output for debug info
				ImgCache.options.debug = true;
				ImgCache.options.usePersistentCache = true;
	
				ImgCache.init(function() {
					// 1. cache images
					for (var i = 0; i < $proper.length; i++) {
						ImgCache.cacheFile($($proper[i]).attr('src'));
					}
					// 2. broken images get replaced
					for (var i = 0; i < $broken.length; i++) {
						ImgCache.useCachedFile($($broken[i]));
					}

				});
			});
		};

		if (typeof(cordova) !== 'undefined') {
			// cordova test
			document.addEventListener('deviceready', startTest, false);
		} else {
			// normal browser test
			$(document).ready(startTest);
		}
	</script>
	
	<link rel="stylesheet" href="themes/responsiveslide.css"/>
	<script src="jquery/responsiveslides.min.js"></script>
	<script>
    $(function () {
      $(".rslides").responsiveSlides({
      auto: false, 
      pager: false, 
      nav: true, 
      speed: 500, 
      namespace: "callbacks"});
	});
	</script>

	<script>
		$(document).bind("mobileinit", function(){
  			$.mobile.listview.prototype.options.icon = false;
			$.mobile.defaultPageTransition = "none";
			$.mobile.allowCrossDomainPages = true;
			$.mobile.metaViewportContent = 'width=device-width';
		    $.event.special.swipe.horizontalDistanceThreshold = 25; 
   			$.event.special.swipe.verticalDistanceThreshold = 80;
    		$.event.special.swipe.scrollSupressionThreshold = 8;
		});
	</script>
	
	<script>
	$('div.ui-page').live("swipeleft", function(){
	var nextpage = $(this).next('div[data-role="page"]');
	if (nextpage.length > 0) {
	$.mobile.changePage(nextpage, {transition: "slide"}, false, true);
	}
	});
	$('div.ui-page').live("swiperight", function(){
	var prevpage = $(this).prev('div[data-role="page"]');
	if (prevpage.length > 0) {
	$.mobile.changePage(prevpage, {transition: "slide",
	reverse: true}, true, true);
	}
	});
	</script>
	
	<script type="text/javascript" charset="utf-8">
	//Global instance of DirectoryEntry for our data
	var DATADIR;
	var knownfiles = [];    

	//Loaded my file system, now let's get a directory entry for where I'll store my crap    
	function onFSSuccess(fileSystem) {
		fileSystem.root.getDirectory("com.camden.imagedownloaddemo",{create:true},gotDir,onError);
	}

	//The directory entry callback
	function gotDir(d){
		console.log("got dir");
		DATADIR = d;
		var reader = DATADIR.createReader();
		reader.readEntries(function(d){
			gotFiles(d);
			appReady();
		},onError);
	}

	//Result of reading my directory
	function gotFiles(entries) {
		console.log("The dir has "+entries.length+" entries.");
	for (var i=0; i<entries.length; i++) {
	console.log(entries[i].name+' dir? '+entries[i].isDirectory);
			knownfiles.push(entries[i].name);
			renderPicture(entries[i].fullPath);
	}
	}

	function renderPicture(path){
		$("#photos").append("<img src='file://"+path+"'>");
		console.log("<img src='file://"+path+"'>");
	}

	function onError(e){
		console.log("ERROR");
		console.log(JSON.stringify(e));
	}

	function onDeviceReady() {
		//what do we have in cache already?
		$("#status").html("Checking your local cache....");    
		window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, onFSSuccess, null);    
	}

	function appReady(){
		$("#status").html("Ready to check remote files...");
		$.get("http://www.raymondcamden.com/demos/2012/jan/17/imagelister.cfc?method=listimages", {}, function(res) {
			if (res.length > 0) {
				$("#status").html("Going to sync some images...");
				for (var i = 0; i < res.length; i++) {
					if (knownfiles.indexOf(res[i]) == -1) {
						console.log("need to download " + res[i]);
						var ft = new FileTransfer();
						var dlPath = DATADIR.fullPath + "/" + res[i];
						console.log("downloading crap to " + dlPath);
						ft.download("http://www.raymondcamden.com/demos/2012/jan/17/" + escape(res[i]), dlPath, function(e){
							renderPicture(e.fullPath);
							console.log("Successful download of "+e.fullPath);
						}, onError);
					}
				}
			}
			$("#status").html("");
		}, "json");

	}

	function init() {
	document.addEventListener("deviceready", onDeviceReady, true);
	}
	</script> 
	
</head>

<body onload="init();">
<h2>Image Download Demo</h2>

<div id="status"></div>

<div id="photos"></div>

</body>
</html>